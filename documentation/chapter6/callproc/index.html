<!doctype html><html><head><meta charset=utf-8><base href=http://localhost:1313/><title>Pgjdbc | Calling Stored Functions and Procedures</title><link rel=stylesheet href=http://localhost:1313/sass/main.4444731f7116386ab6822ca30bdfcce309f779d0e912deceb72a9585a99593b4.css integrity="sha256-RERzH3EWOGq2giyjC9/M4wn3edDpEt7OtyqVhamVk7Q="><link rel=icon href=favicon.ico type=image/x-icon><link rel="shortcut icon" href=favicon.ico type=image/x-icon></head><body><nav class=nav><a href=/>Home</a>
<a class=nav__item href=/development/>Development</a>
<a class=nav__item href=/download/>Download</a>
<a class=nav__item href=/documentation/>Documentation</a>
<a class=nav__item href=/community/>Community</a></nav><main><article><h1>Calling Stored Functions and Procedures</h1><p><p>PostgreSQL™ supports two types of stored objects, functions that can return a
result value and - starting from v11 - procedures that can perform transaction
control. Both types of stored objects are invoked using <code>CallableStatement</code> and
the standard JDBC escape call syntax <code>{call storedobject(?)}</code>. The
<code>escapeSyntaxCallMode</code> connection property controls how the driver transforms the
call syntax to invoke functions or procedures.</p><p>The default mode, <code>select</code>, supports backwards compatibility for existing
applications and supports function invocation only. This is required to invoke
a void returning function. For new applications, use
<code>escapeSyntaxCallMode=callIfNoReturn</code> to map <code>CallableStatement</code>s with return
values to stored functions and <code>CallableStatement</code>s without return values to
stored procedures.</p><p><strong>Example 6.1. Calling a built in stored function</strong></p><p>This example shows how to call a PostgreSQL™ built in function, <code>upper</code>, which
simply converts the supplied string argument to uppercase.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>CallableStatement upperFunc <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span><span style=color:#a6e22e>prepareCall</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;{? = call upper( ? ) }&#34;</span><span style=color:#f92672>);</span>
upperFunc<span style=color:#f92672>.</span><span style=color:#a6e22e>registerOutParameter</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> Types<span style=color:#f92672>.</span><span style=color:#a6e22e>VARCHAR</span><span style=color:#f92672>);</span>
upperFunc<span style=color:#f92672>.</span><span style=color:#a6e22e>setString</span><span style=color:#f92672>(</span>2<span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;lowercase to uppercase&#34;</span><span style=color:#f92672>);</span>
upperFunc<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
String upperCased <span style=color:#f92672>=</span> upperFunc<span style=color:#f92672>.</span><span style=color:#a6e22e>getString</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
upperFunc<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</code></pre></div><p></p><h1 id=obtaining-a-resultset-from-a-stored-function>Obtaining a <code>ResultSet</code> from a stored function</h1><p>PostgreSQL&rsquo;s™ stored functions can return results in two different ways. The
function may return either a refcursor value or a <code>SETOF</code> some datatype. Depending
on which of these return methods are used determines how the function should be
called.</p><p></p><h2 id=from-a-function-returning-setof-type>From a Function Returning <code>SETOF</code> type</h2><p>Functions that return data as a set should not be called via the <code>CallableStatement</code>
interface, but instead should use the normal <code>Statement</code> or <code>PreparedStatement</code>
interfaces.</p><p><strong>Example 6.2. Getting <code>SETOF</code> type values from a function</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>Statement stmt <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span><span style=color:#a6e22e>createStatement</span><span style=color:#f92672>();</span>
stmt<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;CREATE OR REPLACE FUNCTION setoffunc() RETURNS SETOF int AS &#34;</span>
    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&#39; SELECT 1 UNION SELECT 2;&#39; LANGUAGE sql&#34;</span><span style=color:#f92672>);</span>
ResultSet rs <span style=color:#f92672>=</span> stmt<span style=color:#f92672>.</span><span style=color:#a6e22e>executeQuery</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;SELECT * FROM setoffunc()&#34;</span><span style=color:#f92672>);</span>
<span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>rs<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>())</span>
<span style=color:#f92672>{</span>
    <span style=color:#75715e>// do something
</span><span style=color:#75715e></span><span style=color:#f92672>}</span>
rs<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
stmt<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</code></pre></div><p></p><h2 id=from-a-function-returning-a-refcursor>From a Function Returning a refcursor</h2><p>When calling a function that returns a refcursor you must cast the return type of
<code>getObject</code> to a <code>ResultSet</code></p><h3 id=note>Note</h3><blockquote><p>One notable limitation of the current support for a <code>ResultSet</code> created from
a refcursor is that even though it is a cursor backed <code>ResultSet</code>, all data will
be retrieved and cached on the client. The <code>Statement</code> fetch size parameter
described in the section called <a href=query.html#query-with-cursor>“Getting results based on a cursor”</a>
is ignored. This limitation is a deficiency of the JDBC driver, not the server,
and it is technically possible to remove it, we just haven&rsquo;t found the time.</p></blockquote><p><strong>Example 6.3. Getting refcursor Value From a Function</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// Setup function to call.
</span><span style=color:#75715e></span>Statement stmt <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span><span style=color:#a6e22e>createStatement</span><span style=color:#f92672>();</span>
stmt<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;CREATE OR REPLACE FUNCTION refcursorfunc() RETURNS refcursor AS &#39;&#34;</span>
    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; DECLARE &#34;</span>
    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;    mycurs refcursor; &#34;</span>
    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; BEGIN &#34;</span>
    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;    OPEN mycurs FOR SELECT 1 UNION SELECT 2; &#34;</span>
    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;    RETURN mycurs; &#34;</span>
    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; END;&#39; language plpgsql&#34;</span><span style=color:#f92672>);</span>
stmt<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>

<span style=color:#75715e>// We must be inside a transaction for cursors to work.
</span><span style=color:#75715e></span>conn<span style=color:#f92672>.</span><span style=color:#a6e22e>setAutoCommit</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>

<span style=color:#75715e>// Function call.
</span><span style=color:#75715e></span>CallableStatement func <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span><span style=color:#a6e22e>prepareCall</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;{? = call refcursorfunc() }&#34;</span><span style=color:#f92672>);</span>
func<span style=color:#f92672>.</span><span style=color:#a6e22e>registerOutParameter</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> Types<span style=color:#f92672>.</span><span style=color:#a6e22e>OTHER</span><span style=color:#f92672>);</span>
func<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
ResultSet results <span style=color:#f92672>=</span> <span style=color:#f92672>(</span>ResultSet<span style=color:#f92672>)</span> func<span style=color:#f92672>.</span><span style=color:#a6e22e>getObject</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
<span style=color:#66d9ef>while</span> <span style=color:#f92672>(</span>results<span style=color:#f92672>.</span><span style=color:#a6e22e>next</span><span style=color:#f92672>())</span>
<span style=color:#f92672>{</span>
    <span style=color:#75715e>// do something with the results.
</span><span style=color:#75715e></span><span style=color:#f92672>}</span>
results<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
func<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</code></pre></div><p>It is also possible to treat the refcursor return value as a cursor name directly.
To do this, use the <code>getString</code> of <code>ResultSet</code>. With the underlying cursor name,
you are free to directly use cursor commands on it, such as <code>FETCH</code> and <code>MOVE</code>.</p><p><strong>Example 6.4. Treating refcursor as a cursor name</strong></p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java>conn<span style=color:#f92672>.</span><span style=color:#a6e22e>setAutoCommit</span><span style=color:#f92672>(</span><span style=color:#66d9ef>false</span><span style=color:#f92672>);</span>
CallableStatement func <span style=color:#f92672>=</span> conn<span style=color:#f92672>.</span><span style=color:#a6e22e>prepareCall</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;{? = call refcursorfunc() }&#34;</span><span style=color:#f92672>);</span>
func<span style=color:#f92672>.</span><span style=color:#a6e22e>registerOutParameter</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> Types<span style=color:#f92672>.</span><span style=color:#a6e22e>OTHER</span><span style=color:#f92672>);</span>
func<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
String cursorName <span style=color:#f92672>=</span> func<span style=color:#f92672>.</span><span style=color:#a6e22e>getString</span><span style=color:#f92672>(</span>1<span style=color:#f92672>);</span>
func<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</code></pre></div><p>**Example 6.5. Calling a stored procedure</p><p>This example shows how to call a PostgreSQL™ procedure that uses transaction control.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=color:#75715e>// set up a connection
</span><span style=color:#75715e></span>String url <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;jdbc:postgresql://localhost/test&#34;</span><span style=color:#f92672>;</span>
Properties props <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Properties<span style=color:#f92672>();</span>
<span style=color:#f92672>...</span> other properties <span style=color:#f92672>...</span>
<span style=color:#75715e>// Ensure EscapeSyntaxCallmode property set to support procedures if no return value
</span><span style=color:#75715e></span>props<span style=color:#f92672>.</span><span style=color:#a6e22e>setProperty</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;escapeSyntaxCallMode&#34;</span><span style=color:#f92672>,</span> <span style=color:#e6db74>&#34;callIfNoReturn&#34;</span><span style=color:#f92672>);</span>
Connection con <span style=color:#f92672>=</span> DriverManager<span style=color:#f92672>.</span><span style=color:#a6e22e>getConnection</span><span style=color:#f92672>(</span>url<span style=color:#f92672>,</span> props<span style=color:#f92672>);</span>

<span style=color:#75715e>// Setup procedure to call.
</span><span style=color:#75715e></span>Statement stmt <span style=color:#f92672>=</span> con<span style=color:#f92672>.</span><span style=color:#a6e22e>createStatement</span><span style=color:#f92672>();</span>
stmt<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;CREATE TEMP TABLE temp_val ( some_val bigint )&#34;</span><span style=color:#f92672>);</span>
stmt<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;CREATE OR REPLACE PROCEDURE commitproc(a INOUT bigint) AS &#39;&#34;</span>
    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; BEGIN &#34;</span>
    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;    INSERT INTO temp_val values(a); &#34;</span>
    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;    COMMIT; &#34;</span>
    <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; END;&#39; LANGUAGE plpgsql&#34;</span><span style=color:#f92672>);</span>
stmt<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>

<span style=color:#75715e>// As of v11, we must be outside a transaction for procedures with transactions to work.
</span><span style=color:#75715e></span>con<span style=color:#f92672>.</span><span style=color:#a6e22e>setAutoCommit</span><span style=color:#f92672>(</span><span style=color:#66d9ef>true</span><span style=color:#f92672>);</span>

<span style=color:#75715e>// Procedure call with transaction
</span><span style=color:#75715e></span>CallableStatement proc <span style=color:#f92672>=</span> con<span style=color:#f92672>.</span><span style=color:#a6e22e>prepareCall</span><span style=color:#f92672>(</span><span style=color:#e6db74>&#34;{call commitproc( ? )}&#34;</span><span style=color:#f92672>);</span>
proc<span style=color:#f92672>.</span><span style=color:#a6e22e>setInt</span><span style=color:#f92672>(</span>1<span style=color:#f92672>,</span> 100<span style=color:#f92672>);</span>
proc<span style=color:#f92672>.</span><span style=color:#a6e22e>execute</span><span style=color:#f92672>();</span>
proc<span style=color:#f92672>.</span><span style=color:#a6e22e>close</span><span style=color:#f92672>();</span>
</code></pre></div></p></article></main><hr><footer><div><p>Copyright © 1996-2022 The PostgreSQL Global Development Group</p></div></footer></body></html>